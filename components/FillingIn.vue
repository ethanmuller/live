<template>
  <div id="poemcontainer">

    <div :class="{columncontainer: isScreen}">
      <div :class="{ poemcolumn: isScreen, column1: isScreen }">
        <h1 id="title">
          填充題
        </h1>
        <p>
          <span>長頭髮的<WordSelector i="0" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='1' :wordList='wordList' :blankList='blankList' :socket='socket' />住在<WordSelector i="1" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' />裡</span>
          <span>討厭<WordSelector i="2" anchor="left" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' />裡強壯的<WordSelector i="3" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' /></span>
          <span>笑起來像<WordSelector i="4" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' /></span>
          <span>忘記的時候像<WordSelector i="5" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' />的<WordSelector i="6" v-on:wordSelectorOpen="wordSelectorOpen" anchor="right" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' /></span>
        </p>
        <p>
          <span>有一天<WordSelector i="7" anchor="left" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='1' :wordList='wordList' :blankList='blankList' :socket='socket' />被<WordSelector i="8" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' />了</span>
          <span><WordSelector i="9" anchor="left" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='1' :wordList='wordList' :blankList='blankList' :socket='socket' />們不知道明天會有什麼<WordSelector i="10" anchor="right" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' /></span>
          <span><WordSelector i="11" anchor="left" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='1' :wordList='wordList' :blankList='blankList' :socket='socket' />在<WordSelector i="12" anchor="left" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' />裡等待著<WordSelector i="13" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' />出現</span>
          <span>途中<WordSelector i="14" anchor="left" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' />死了<WordSelector i="15" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='1' :wordList='wordList' :blankList='blankList' :socket='socket' />次</span>
        </p>
      </div>
      <div :class="{ poemcolumn: isScreen, column2: isScreen }">
        <p>
          <span>幸好還有<WordSelector i="16" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' /></span>
          <span><WordSelector i="17" anchor="left" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='1' :wordList='wordList' :blankList='blankList' :socket='socket' />帶著<WordSelector i="18" anchor="left" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' />和<WordSelector i="19" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' /></span>
          <span>用時間和<WordSelector i="20" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' /></span>
          <span>尋回了<WordSelector i="21" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='4' :wordList='wordList' :blankList='blankList' :socket='socket' />的<WordSelector i="22" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='2' :wordList='wordList' :blankList='blankList' :socket='socket' /></span>
        </p>
        <p>
          <span>那天以後</span>
          <span>一切都<WordSelector i="23" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='4' :wordList='wordList' :blankList='blankList' :socket='socket' /></span>
          <span>可是永遠有人記得那個<WordSelector i="24" v-on:wordSelectorOpen="wordSelectorOpen" v-on:wordSelectorClose="wordSelectorClose" :isLocked="isLocked && !isMod" length='1' :wordList='wordList' :blankList='blankList' :socket='socket' />月</span>
          <span>非常非常地冷</span>
        </p>
      </div>
    </div>

  </div>
</template>

<script>
import QRCode from 'qrcode'
import socket from '~/plugins/socket.io-client.js'
import wordList from '../fei-words.js'


export default {
  data() {
    return {
      socket: socket,
      isMod: this.$route.query.role === 'mod',
      isScreen: this.$route.query.role === 'screen',
      wordList,
      blankList: new Array(wordList.length),
      isLocked: false,
      url: '',

      // Only one WordSelector is allowed open at a time.
      // This represents the index of the one that's open.
      //openWordSelectorIndex: -1,
    }
  },

  watch: {
    'blankList': function(blankList) {
      // whenever blankList changes,
      // we programatically update each WordSelector component
      // to reflect the newly received list of what words are in which slots

      const wordSelectorComponents = this.$children.filter(c => c.$options._componentTag === 'WordSelector')

      wordSelectorComponents.forEach((wordSelector,index) => {
        if (!!blankList[index] && blankList[index].length !== 20) {
          wordSelector.setWord(blankList[index])
        } else {
          wordSelector.setWord('')
        }
      })
    }
  },

  mounted() {
    this.url = window.location.protocol + '//' + window.location.host + window.location.pathname

    this.socket.on('connect', this.connect)
    this.socket.on('new state', this.setState)
    this.socket.emit('join', (state) => {
      this.blankList = state.blankList
      this.isLocked = state.isLocked
    })
  },

  beforeDestroy() {
  },

  methods: {
    connect() {
      console.log('connected')
    },
    wordSelectorOpen(i) {
    },
    wordSelectorClose() {
      this.openWordSelectorIndex = -1
    },
    offerReset() {
      if (confirm('Are you sure you want to reset everything?')) {
        this.sendReset()
      }
    },
    sendReset() {
      this.socket.emit('send reset')
    },
    sendLock() {
      this.socket.emit('lock state')
    },
    sendUnlock() {
      this.socket.emit('unlock state')
    },
    reset() {
      this.blankList = new Array(wordList.length)
      const wordSelectorComponents = this.$children.filter(c => c._name === '<WordSelector>');

      wordSelectorComponents.forEach((wordSelector,index) => {
        wordSelector.setWord('')
      })
    },

    setState(newState) {
      this.blankList = newState.blankList
      this.isLocked = newState.isLocked
    }
  },
}
</script>

<style>
  p {
    margin: 0 0 2rem;
  }
  p > span {
    display: block;
  }
  .partylink {
    padding: 0.5rem; display: inline-block;
  }

  #poemcontainer {
    width: 100%;
    font-family: 'Noto Sans TC', sans-serif;
    max-width: 18em;
    line-height: 1.3;

    font-size: 1.2rem;
    padding: 0.5em 0.5em 9em;
  }
  @media (min-width: calc(336px)) {
    #poemcontainer {
      /* this font size will grow with the browser */
      font-size: calc(0.2rem + 5vw);
    }
  }
  @media (min-width: calc(590px)) {
    #poemcontainer {
      /* cap off font size growth */
      font-size: 2rem;
    }
  }
  /* This styling only happens if we are a role=screen, and actually I've been only testing it against a 1280p screen */
  @media (max-height: calc(1000px)) and (min-width: calc(1100px)) {
    .poemcolumn {
        float:left;
        min-width: 100%;
    }
    /* .column1 {
      transform: translate(calc(-50%), 0);
    }*/
    .column2 {
      margin-top: calc(106px);
    }
    .columncontainer {
      display: flex;
      flex-direction: row;
      justify-content: center;
    }

    #title {
      text-align: left;
    }
  }

</style>
